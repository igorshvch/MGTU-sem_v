# 9. [Целостность базы данных](#целостность-базы-данных). [Декларативная и процедурная поддержка ограничений целостности](#декларативная-и-процедурная-поддержка-ограничений-целостности)

## Целостность базы данных

**Целостность данных** – соответствие имеющейся в БД информации ее внутренней логике, структуре и всем явно заданным правилам: ограничения, индексы (ограничения уникальности, первичные ключи), триггеры и т.д.

**Ограничения целостности данных** можно определить как специальные средства в базах данных, главное назначение которых - не дать попасть в базу недопустимым данным (например, предупредить ошибки пользователей при вводе данных).

Все ограничения целостности можно разделить на три большие категории

- первая категория - средства обеспечения доменной целостности. Они отвечают за то, чтобы в соответствующем поле базы данных были допустимые значения. Например, фамилия, как правило, должна состоять из букв, а почтовый индекс - из цифр. В базах данных такая целостность обычно обеспечивается условиями на значение, запретом пустых значений, триггерами и хранимыми процедурами, а также ключами;

- вторая категория - сущностная целостность. Главная задача здесь - сделать так, чтобы данные об одной сущности не попали в базу данных два раза. Обеспечивается ограничением уникальности и первичным ключом;

- третья категория - ссылочная целостность, обеспечивается системой первичных и внешних ключей. Например, при помощи этих средств можно гарантировать, что у нас не будет заказов, оформленных на покупателей, которых нет в базе данных.

База данных находится в **согласованном (целостном) состоянии**, если выполнены (удовлетворены) все ограничения целостности, определённые для базы данных.

**Средства обеспечения целостности БД** можно разделить на:

- Декларативные
- Процедурные

## Декларативная и процедурная поддержка ограничений целостности

### Простой пример отношений для дальнейшего изложения

Таблица PERSON

|Pers_Id|Pers_Name|Dept_Id|
|-|-|-|
|1|Иванов|1|
|2|Петров|2|
|3|Сидоров|1|
|4|Васнецов|2|
|5|Айвазовский|1|

Таблица DEPART

|Dept_Id|Dept_Name|Dept_Qnt|
|-|-|-|
|1|Кафедра высшей алгербры|12|
|2|Кафедра математического анализа|18|

### Декларативная поддержка

Заключается в определении ограничений средствами языка определения данных ([DDL](05.md#ddl))

Обычно средства декларативной поддержки целостности (если они имеются в СУБД) определяют ограничения на значения доменов и атрибутов, целостность сущностей (потенциальные ключи отношений) и ссылочную целостность (целостность внешних ключей). Декларативные ограничения целостности можно использовать при создании и модификации таблиц средствами языка DDL или в виде отдельных утверждений (ASSERTION).

Например, следующий оператор создает таблицу PERSON и определяет для нее некоторые ограничения целостности:

```postgresql
CREATE TABLE PERSON
  (Pers_Id INTEGER PRIMARY KEY,
  Pers_Name CHAR(30) NOT NULL,
  Dept_Id REFERENCES DEPART(Dept_Id) ON UPDATE CASCADE ON DELETE CASCADE);
```

После выполнения оператора для таблицы PERSON будут объявлены следующие ограничения целостности:

- Поле Pers_Id образует потенциальный ключ отношения.
- Поле Pers_Name не может содержать null-значений.
- Поле Dept_Id является внешней ссылкой на родительскую таблицу DEPART, причем, при изменении или удалении строки в родительской таблице каскадно должны быть внесены соответствующие изменения в дочернюю таблицу.

### Процедурная поддержка

Заключается в использовании *триггеров* и *хранимых процедур*

Не все ограничения целостности можно реализовать декларативно. Примером такого ограничения может служить требование из примера 1, утверждающее, что поле Dept_Qnt таблицы DEPART должно содержать количество сотрудников, реально числящихся в подразделении. Для реализации этого ограничения необходимо создать триггер, запускающийся при вставке, модификации и удалении записей в таблице PERSON, который корректно изменяет значение поля Dept_Qnt. Например, при вставке в таблицу PERSON новой строки, триггер увеличивает на единицу значение поля Dept_Qnt, а при удалении строки - уменьшает. Заметим, что при модификации записей в таблице PERSON могут потребоваться даже более сложные действия. Действительно, модификация записи в таблице PERSON может заключаться в том, что мы переводим сотрудника из одного отдела в другой, меняя значение в поле Dept_Id. При этом необходимо в старом подразделении уменьшить количество сотрудников, а в новом - увеличить.

По сути, наличие ограничения целостности (как декларативного, так и процедурного характера) всегда приводит к созданию или использованию некоторого программного кода, реализующего это ограничение. Разница заключается в том, где такой код хранится и как он создается.

Если ограничение целостности реализовано в виде триггеров, то этот программный код является просто телом триггера. Если используется декларативное ограничение целостности, то возможны два подхода:

- При декларировании (объявлении) ограничения текст ограничения хранится в виде некоторого объекта СУБД, а для реализации ограничения используются встроенные в СУБД функции, и тогда этот код представляет собой внутренние функции ядра СУБД.
- При декларировании ограничения СУБД автоматически генерирует триггеры, выполняющие необходимые действия по проверке ограничений.

---

## [:back: **К списку вопросов**](../README.md)

---
