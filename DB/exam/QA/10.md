# 10. [Язык SQL](#язык-sql). [DML](#dml). [Операторы INSERT, UPDATE, DELETE](#операторы-insert-update-delete). [Синтаксис insert-select и update-from](#синтаксис-insert-select-и-update-from). [Получение идентификатора, сгенерированного при вставке](#получение-идентификатора-сгенерированного-при-вставке)

## Язык SQL

См. Вопрос 5: [Язык SQL](05.md#язык-sql)

## DML

SQL. Data Manipulation Language (DML):

- Добавление данных: `INSERT`, `BULK INSERT`
`BULK INSERT` – вставка не одной, а нескольких записей. При этом множественный вызов `INSERT` не эквивалентен `BULK INSERT`. Последняя операция – оптимизированная и более быстрая.
- Изменение данных: `UPDATE`
- Запрос данных: `SELECT`
- Удаление: `DELETE`
- Комплексные операции обработки данных: `MERGE` (используется при выполнении нескольких разных операций, позволяет слить данные одной таблицы с данными другой таблицы[^1]. В PostgreSQL **не** реализован)

Подробнее по операторам применительно к PostgreSQL см.:

- Документация PostgreSQL. [Команды SQL](https://postgrespro.ru/docs/postgresql/14/sql-commands)

## Операторы INSERT, UPDATE, DELETE

По операторам применительно к PostgreSQL см.:

- Документация PostgreSQL. [INSERT](https://postgrespro.ru/docs/postgresql/14/sql-insert)

  Имена целевых столбцов могут перечисляться в любом порядке. Если список с именами столбцов отсутствует, по умолчанию целевыми столбцами становятся все столбцы заданной таблицы; либо первые N из них, если только N столбцов поступает от предложения VALUES или запроса. Значения, получаемые от предложения VALUES или запроса, связываются с явно или неявно определённым списком столбцов слева направо.
  
  Все столбцы, не представленные в явном или неявном списке столбцов, получат значения по умолчанию, если для них заданы эти значения, либо `NULL` в противном случае.

  По `INSERT` следует коснуться:
  
  - темы `UPSERT` - вставки при конфликте из-за наличия данного, когда требуется обновить данное (тема есть в документации)
  - темы SQL injenction - для борьбы с это уязвимостью вставлять надо не непорседственно пользовательские значения, а сначала занести их в переменные и уже потом вставлять переменные в запрос `INSERT`. Разница в том, что данные в переменных будут интерпретироваться как строки и в любом случае не будут выполняться. в отличие от использования пользовательских данных на пряму

- Документация PostgreSQL. [UPDATE](https://postgrespro.ru/docs/postgresql/14/sql-update)

  В `UPDATE` запрос `WHERE` может быть любой сложности (т.е. можно использовать большое количество операторов и "уровней вложенности")

  Изменить строки в таблице, используя информацию из других таблиц в базе данных, можно двумя способами: применяя вложенные запросы или указав дополнительные таблицы в предложении `FROM`. Выбор предпочитаемого варианта зависит от конкретных обстоятельств.

- Документация PostgreSQL. [DELETE](https://postgrespro.ru/docs/postgresql/14/sql-delete)

## Синтаксис insert-select и update-from

### insert-select

Речь, по-видимому, про вот [это](https://www.w3schools.com/sql/sql_insert_into_select.asp)

Также см. в [документации](https://postgrespro.ru/docs/postgresql/14/sql-insert) пример про вставку в текущую таблицу значений из другой таблицы (это то же, о чем идет речь в ссылке выше):

```postgresql
INSERT INTO films SELECT * FROM tmp_films WHERE date_prod < '2004-05-07';
```

### update-from

По-видимому, речь про вот [это](https://stackoverflow.com/questions/2334712/how-do-i-update-from-a-select-in-sql-server)

По сути, это операция (обновление полей) аналогична множественной вставке в рассматриваемую таблицу из какой-то другой таблицы в БД

## Получение идентификатора, сгенерированного при вставке

В PostgreSQL можно получить значение сгенерированного идентификатора несколькими путями. Два неправильных варианта - это исползование встроенных функций:

- `CURRVAL('sequenceName')` (возвращает текущее значение указанной последовательности)
- `LASTVAL()` (возвращает последнее значение той последовательности, которая была модифицирована в ходе текущей сессии)

Проблемы с указанными вариантами - область видимости не ограничена текущим, также на результат может повлять триггер или правило.

Правильный вариант - использовать совместно с `INSERT` ключевое слово `RETURNING`:

```postrgesql
INSERT INOT public."Cities" (Name)
VALUES ('Moscow')
RETURNING Id
```

С необязательным предложением `RETURNING` команда `INSERT` вычислит и возвратит значения для каждой фактически добавленной строки (или изменённой, если применялось предложение `ON CONFLICT DO UPDATE`). В основном это полезно для получения значений, присвоенных по умолчанию, например, последовательного номера записи. Однако в этом предложении можно задать любое выражение со столбцами таблицы. Список `RETURNING` имеет тот же синтаксис, что и список результатов `SELECT`.

Подробнее см.

- [здесь](https://coderoad.ru/2944297/PostgreSQL-%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D1%8F-%D0%B4%D0%BB%D1%8F-%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B5%D0%B9-%D0%B2%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%BD%D0%BE%D0%B9-ID)
- Документация PostgreSQL. [INSERT](https://postgrespro.ru/docs/postgresql/14/sql-insert)

---

## [:back: **К списку вопросов**](../README.md)

---

[^1]: Подброднее см. [википедию](https://ru.wikipedia.org/wiki/Merge_(SQL))
